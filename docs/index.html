<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Hanh Hoa Don</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
<style>
* { -webkit-tap-highlight-color: transparent; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 0; }
.screen { display: none; }
.screen.active { display: block; }
.radio-checked { background: #10b981; }
.vat-active { background: #dbeafe !important; border-color: #3b82f6 !important; color: #3b82f6 !important; }
</style>
</head>
<body class="bg-gray-100">

<!-- Settings Screen -->
<div id="settings-screen" class="screen active min-h-screen" style="background: #1a4d2e;">
<div class="p-6">
<h1 class="text-xl font-semibold text-white mb-6">CÃ i Ä‘áº·t</h1>
<div class="mb-8">
<h2 class="text-white font-semibold mb-4">NgÃ´n ngá»¯</h2>
<div onclick="setLanguage('vi')" class="bg-white bg-opacity-10 rounded-xl p-4 mb-3 border-2 border-green-500 cursor-pointer" id="lang-vi">
<div class="flex items-center">
<div class="w-5 h-5 rounded-full border-2 border-green-500 flex items-center justify-center mr-3">
<div class="w-2.5 h-2.5 rounded-full radio-checked" id="radio-vi"></div>
</div>
<div class="flex-1"><p class="text-white font-medium">Tiáº¿ng Viá»‡t</p></div>
<span class="text-2xl">ğŸ‡»ğŸ‡³</span>
</div>
</div>
<div onclick="setLanguage('ja')" class="bg-white bg-opacity-10 rounded-xl p-4 border-2 border-transparent cursor-pointer" id="lang-ja">
<div class="flex items-center">
<div class="w-5 h-5 rounded-full border-2 border-green-500 flex items-center justify-center mr-3">
<div class="w-2.5 h-2.5 rounded-full" id="radio-ja"></div>
</div>
<div class="flex-1"><p class="text-white font-medium">æ—¥æœ¬èª</p></div>
<span class="text-2xl">ğŸ‡¯ğŸ‡µ</span>
</div>
</div>
</div>
<div class="mb-8">
<h2 class="text-white font-semibold mb-4">Tiá»n tá»‡</h2>
<div onclick="setCurrency('VND')" class="bg-white bg-opacity-10 rounded-xl p-4 mb-3 border-2 border-transparent cursor-pointer" id="curr-vnd">
<div class="flex items-center">
<div class="w-5 h-5 rounded-full border-2 border-green-500 flex items-center justify-center mr-3">
<div class="w-2.5 h-2.5 rounded-full" id="radio-vnd"></div>
</div>
<div class="flex-1"><p class="text-white font-medium">VND (â‚«)</p></div>
<span class="text-2xl text-green-500 font-bold">â‚«</span>
</div>
</div>
<div onclick="setCurrency('JPY')" class="bg-white bg-opacity-10 rounded-xl p-4 border-2 border-green-500 cursor-pointer" id="curr-jpy">
<div class="flex items-center">
<div class="w-5 h-5 rounded-full border-2 border-green-500 flex items-center justify-center mr-3">
<div class="w-2.5 h-2.5 rounded-full radio-checked" id="radio-jpy"></div>
</div>
<div class="flex-1"><p class="text-white font-medium">JPY (Â¥)</p></div>
<span class="text-2xl text-green-500 font-bold">Â¥</span>
</div>
</div>
</div>
<button onclick="showScreen('dashboard')" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl">Tiáº¿p tá»¥c â†’ Dashboard</button>
</div>
</div>

<!-- Dashboard Screen -->
<div id="dashboard-screen" class="screen min-h-screen" style="background: #0f172a;">
<div class="p-6">
<div class="flex items-center justify-between mb-6">
<div class="flex items-center">
<div class="w-10 h-10 rounded-full bg-orange-500 flex items-center justify-center mr-3">
<span class="text-white font-bold text-lg">ğŸ“Š</span>
</div>
<div>
<p class="text-gray-400 text-xs" id="greeting-text">Xin chÃ o ğŸ‘‹</p>
<p class="text-white font-semibold">Dashboard</p>
</div>
</div>
<button onclick="showScreen('settings')" class="w-9 h-9 rounded-full bg-gray-800 flex items-center justify-center">âš™ï¸</button>
</div>
<div class="rounded-2xl p-6 mb-6" style="background: #1e3a5f;">
<p class="text-gray-400 text-xs font-semibold mb-2" id="revenue-text">ğŸ’° Tá»”NG DOANH THU</p>
<p class="text-white text-4xl font-bold mb-4" id="total-revenue">Â¥0</p>
<div class="h-32 flex items-end justify-between gap-1 mt-4">
<div class="flex-1 bg-blue-500 rounded-t" style="height: 60%;"></div>
<div class="flex-1 bg-blue-500 rounded-t" style="height: 45%;"></div>
<div class="flex-1 bg-blue-500 rounded-t" style="height: 75%;"></div>
<div class="flex-1 bg-blue-500 rounded-t" style="height: 55%;"></div>
<div class="flex-1 bg-blue-500 rounded-t" style="height: 80%;"></div>
<div class="flex-1 bg-blue-500 rounded-t" style="height: 90%;"></div>
<div class="flex-1 bg-blue-500 rounded-t" style="height: 70%;"></div>
</div>
</div>
<div class="mb-6">
<p class="text-white font-semibold mb-4" id="quick-actions-text">Tiá»‡n Ã­ch âš¡</p>
<div class="grid grid-cols-2 gap-3">
<button onclick="showScreen('invoice')" class="bg-blue-500 rounded-2xl p-4 text-left">
<p class="text-3xl mb-2">ğŸ“„</p>
<p class="text-white font-semibold text-sm" id="btn-new-invoice">Láº­p Ä‘Æ¡n má»›i</p>
</button>
<button class="bg-pink-500 rounded-2xl p-4 text-left">
<p class="text-3xl mb-2">ğŸ“±</p>
<p class="text-white font-semibold text-sm" id="btn-scan-qr">QuÃ©t QR</p>
</button>
<button class="bg-orange-500 rounded-2xl p-4 text-left">
<p class="text-3xl mb-2">ğŸ“¦</p>
<p class="text-white font-semibold text-sm" id="btn-add-items">ThÃªm hÃ ng</p>
</button>
<button onclick="goToInvoiceAndAddCustomer()" class="bg-green-500 rounded-2xl p-4 text-left">
<p class="text-3xl mb-2">ğŸ‘¤</p>
<p class="text-white font-semibold text-sm" id="btn-add-customer">ThÃªm khÃ¡ch</p>
</button>
</div>
</div>
</div>
</div>

<!-- Invoice Screen -->
<div id="invoice-screen" class="screen min-h-screen bg-gray-100">
<div id="invoice-content">
<div class="bg-white p-4 flex items-center justify-between">
<button onclick="showScreen('dashboard')" class="text-2xl">â†</button>
<h1 class="font-semibold">HÃ“A ÄÆ N (<span id="invoice-currency">JPY</span>)</h1>
<button onclick="resetInvoice()" class="text-red-500 font-bold text-sm">Reset</button>
</div>
<div class="bg-white m-4 p-4 rounded-xl">
<div class="flex items-center">
<div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center mr-3"><span class="text-2xl">ğŸ“¦</span></div>
<div class="flex-1">
<input type="text" id="store-name" value="" class="font-semibold text-sm border-b border-gray-300 focus:border-blue-500 outline-none px-2 py-1 w-full mb-1" placeholder="âœï¸ Nháº­p tÃªn cá»­a hÃ ng..." autocomplete="off">
<input type="text" id="store-address" value="" class="text-gray-500 text-xs border-b border-gray-200 focus:border-blue-500 outline-none px-2 py-1 w-full mb-1" placeholder="âœï¸ Nháº­p Ä‘á»‹a chá»‰..." autocomplete="off">
<input type="tel" id="store-phone" value="" class="text-gray-500 text-xs border-b border-gray-200 focus:border-blue-500 outline-none px-2 py-1 w-full" placeholder="âœï¸ Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i..." autocomplete="off">
</div>
</div>
</div>
<div class="px-4 flex gap-2 mb-4">
<div class="flex-1">
<p class="text-gray-500 text-xs font-semibold mb-1">MÃƒ HÄ</p>
<div class="bg-white p-2 rounded-lg">
<input type="text" id="invoice-code" value="" class="text-sm w-full outline-none border-b border-gray-200 focus:border-blue-500 px-1" placeholder="âœï¸ Nháº­p mÃ£ hÃ³a Ä‘Æ¡n...">
</div>
</div>
<div class="flex-1">
<p class="text-gray-500 text-xs font-semibold mb-1">NGÃ€Y</p>
<div class="bg-white p-2 rounded-lg">
<input type="date" id="invoice-date" class="text-sm w-full outline-none border-b border-gray-200 focus:border-blue-500 px-1">
</div>
</div>
</div>
<div class="px-4 mb-4">
<div class="flex items-center justify-between mb-3">
<p class="text-xs font-bold">KHÃCH HÃ€NG</p>
<button onclick="addNewCustomer()" class="bg-green-500 text-white text-xs font-bold px-3 py-2 rounded-lg hover:bg-green-600 shadow">+ ThÃªm má»›i</button>
</div>
<div id="customer-list">
<!-- KhÃ¡ch hÃ ng sáº½ Ä‘Æ°á»£c thÃªm vÃ o Ä‘Ã¢y -->
</div>
</div>
<div class="px-4 mb-4">
<div class="flex items-center justify-between mb-2">
<p class="text-xs font-bold">Sáº¢N PHáº¨M <span class="text-gray-400 font-normal" id="product-count">0 máº·t hÃ ng</span></p>
<button onclick="addNewProduct()" class="text-blue-500 text-xs font-bold">+ ThÃªm SP</button>
</div>
<div id="product-list">
<!-- Sáº£n pháº©m sáº½ Ä‘Æ°á»£c thÃªm vÃ o Ä‘Ã¢y -->
</div>
</div>

<div class="px-4 mb-4">
<p class="text-xs font-bold mb-2">THUáº¾ VAT</p>
<div class="flex gap-2">
<button onclick="setVAT(0)" class="flex-1 py-3 rounded-lg bg-white border font-semibold" id="vat-0">0%</button>
<button onclick="setVAT(0.08)" class="flex-1 py-3 rounded-lg bg-white border font-semibold vat-active" id="vat-8">8%</button>
<button onclick="setVAT(0.10)" class="flex-1 py-3 rounded-lg bg-white border font-semibold" id="vat-10">10%</button>
</div>
</div>
<div class="bg-white m-4 p-4 rounded-xl">
<div class="flex justify-between mb-2">
<p class="text-gray-600 text-sm">Táº¡m tÃ­nh</p>
<p class="font-semibold" id="subtotal">Â¥9,500</p>
</div>
<div class="flex justify-between mb-2">
<p class="text-gray-600 text-sm">VAT (<span id="vat-percent">8</span>%)</p>
<p class="font-semibold" id="vat-amount">Â¥760</p>
</div>
<div class="border-t my-2"></div>
<div class="flex justify-between">
<p class="font-bold">Tá»•ng cá»™ng</p>
<p class="font-bold text-xl text-blue-500" id="grand-total">Â¥10,010</p>
</div>
</div>
</div>
<div class="bg-white p-4 border-t">
<p class="text-gray-400 text-xs text-center mb-1">Tá»•ng Thanh ToÃ¡n</p>
<p class="font-bold text-lg text-center mb-3" id="export-total">Â¥10,010</p>
<button onclick="exportInvoice()" class="w-full bg-blue-500 text-white font-bold py-4 rounded-xl">Xuáº¥t hÃ³a Ä‘Æ¡n & Thu tiá»n ğŸ’°</button>
</div>
</div>


<script>
let currentScreen='settings';
let language='vi';
let currency='JPY';
let vatRate=0.08;
let products=[];

const translations={
  vi:{greeting:'Xin chÃ o ğŸ‘‹',revenue:'ğŸ’° Tá»”NG DOANH THU',quickActions:'Tiá»‡n Ã­ch âš¡',newInvoice:'Láº­p Ä‘Æ¡n má»›i',scanQR:'QuÃ©t QR',addItems:'ThÃªm hÃ ng',addCustomer:'ThÃªm khÃ¡ch'},
  ja:{greeting:'ã“ã‚“ã«ã¡ã¯ ğŸ‘‹',revenue:'ğŸ’° ç·åå…¥',quickActions:'ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ âš¡',newInvoice:'æ–°è¦è«‹æ±‚æ›¸',scanQR:'QRã‚¹ã‚­ãƒ£ãƒ³',addItems:'å•†å“è¿½åŠ ',addCustomer:'é¡§å®¢è¿½åŠ '}
};

function showScreen(screen){
  console.log('Switching to:',screen);
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(screen+'-screen').classList.add('active');
  currentScreen=screen;
  updateUI();
}

function setLanguage(lang){
  console.log('Language changed to:',lang);
  language=lang;
  document.querySelectorAll('[id^="lang-"]').forEach(el=>{el.classList.remove('border-green-500');el.classList.add('border-transparent');});
  document.querySelectorAll('[id^="radio-vi"],[id^="radio-ja"]').forEach(el=>el.classList.remove('radio-checked'));
  document.getElementById('lang-'+lang).classList.add('border-green-500');
  document.getElementById('lang-'+lang).classList.remove('border-transparent');
  document.getElementById('radio-'+lang).classList.add('radio-checked');
  updateUI();
}

function setCurrency(curr){
  console.log('Currency changed to:',curr);
  currency=curr;
  document.querySelectorAll('[id^="curr-"]').forEach(el=>{el.classList.remove('border-green-500');el.classList.add('border-transparent');});
  document.querySelectorAll('[id^="radio-vnd"],[id^="radio-jpy"]').forEach(el=>el.classList.remove('radio-checked'));
  document.getElementById('curr-'+curr.toLowerCase()).classList.add('border-green-500');
  document.getElementById('curr-'+curr.toLowerCase()).classList.remove('border-transparent');
  document.getElementById('radio-'+curr.toLowerCase()).classList.add('radio-checked');
  document.getElementById('invoice-currency').textContent=curr;
  calculate();
}

function updateUI(){
  console.log('Updating UI for language:',language);
  const t=translations[language];
  const greetingEl=document.getElementById('greeting-text');
  if(greetingEl)greetingEl.textContent=t.greeting;
  const revenueEl=document.getElementById('revenue-text');
  if(revenueEl)revenueEl.textContent=t.revenue;
  const quickActionsEl=document.getElementById('quick-actions-text');
  if(quickActionsEl)quickActionsEl.textContent=t.quickActions;
  const btnNewInvoice=document.getElementById('btn-new-invoice');
  if(btnNewInvoice)btnNewInvoice.textContent=t.newInvoice;
  const btnScanQR=document.getElementById('btn-scan-qr');
  if(btnScanQR)btnScanQR.textContent=t.scanQR;
  const btnAddItems=document.getElementById('btn-add-items');
  if(btnAddItems)btnAddItems.textContent=t.addItems;
  const btnAddCustomer=document.getElementById('btn-add-customer');
  if(btnAddCustomer)btnAddCustomer.textContent=t.addCustomer;
}

function formatAmount(amount){
  const rounded=Math.round(amount);
  const formatted=rounded.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',');
  return currency==='VND'?formatted+'â‚«':'Â¥'+formatted;
}

function setVAT(rate){
  console.log('VAT:',rate);
  vatRate=rate;
  document.querySelectorAll('[id^="vat-"]').forEach(el=>el.classList.remove('vat-active'));
  const btnId=rate===0?'vat-0':(rate===0.08?'vat-8':'vat-10');
  document.getElementById(btnId).classList.add('vat-active');
  document.getElementById('vat-percent').textContent=Math.round(rate*100);
  calculate();
}

function updateQuantity(index,value){
  products[index].quantity=parseInt(value)||0;
  calculate();
}

function updatePrice(index,value){
  products[index].unitPrice=parseInt(value)||0;
  calculate();
}

function addNewCustomer(){
  console.log('ğŸ”µ addNewCustomer function called');
  const customerList=document.getElementById('customer-list');
  console.log('ğŸ”µ customerList element:',customerList);
  
  if(!customerList){
    console.error('âŒ customer-list element not found!');
    alert('âŒ Lá»—i: KhÃ´ng tÃ¬m tháº¥y danh sÃ¡ch khÃ¡ch hÃ ng!');
    return;
  }
  
  console.log('âœ… customer-list found, creating new customer...');
  
  const newCustomer=document.createElement('div');
  newCustomer.className='bg-green-50 p-3 rounded-xl border-2 border-green-500 mb-2 shadow-lg';
  newCustomer.innerHTML=`
    <div class="flex items-center mb-2">
      <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center mr-3">
        <span class="text-white text-xl">ğŸ‘¤</span>
      </div>
      <input type="text" value="" class="flex-1 font-semibold text-sm border-2 border-green-500 rounded px-2 py-2 focus:border-blue-500 outline-none" placeholder="âœï¸ Nháº­p tÃªn khÃ¡ch hÃ ng..." autocomplete="off">
      <button onclick="removeCustomer(this)" class="text-red-500 ml-2 text-2xl font-bold hover:text-red-700">âœ•</button>
    </div>
    <div class="flex items-center mt-2">
      <span class="text-gray-500 text-sm mr-2">ğŸ“</span>
      <input type="tel" value="" class="flex-1 text-sm border-2 border-green-500 rounded px-2 py-2 focus:border-blue-500 outline-none" placeholder="âœï¸ Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i..." autocomplete="off">
    </div>
    <div class="flex items-center mt-2">
      <span class="text-gray-500 text-sm mr-2">ğŸ“</span>
      <input type="text" value="" class="flex-1 text-sm border-2 border-green-500 rounded px-2 py-2 focus:border-blue-500 outline-none" placeholder="âœï¸ Nháº­p Ä‘á»‹a chá»‰..." autocomplete="off">
    </div>
  `;
  customerList.appendChild(newCustomer);
  console.log('âœ… New customer added successfully!');
  
  // Scroll to the new customer
  newCustomer.scrollIntoView({behavior:'smooth',block:'center'});
  
  // Focus on the new input
  setTimeout(()=>{
    const inputs=newCustomer.querySelectorAll('input');
    if(inputs[0]){
      inputs[0].focus();
      inputs[0].click();
      console.log('âœ… Input focused');
    }
  },300);
}

function removeCustomer(btn){
  const customerDiv=btn.closest('.bg-white, .bg-green-50');
  if(customerDiv){
    customerDiv.remove();
    console.log('âœ… Customer removed');
  }
}

function goToInvoiceAndAddCustomer(){
  console.log('ğŸ”µ Going to invoice and adding customer...');
  showScreen('invoice');
  // Wait for screen to render, then add customer
  setTimeout(()=>{
    addNewCustomer();
  },500);
}

function addNewProduct(){
  const productList=document.getElementById('product-list');
  const index=products.length;
  products.push({quantity:1,unitPrice:0});
  const icons=['ğŸ“¦','ğŸ','ğŸ›ï¸','ğŸ“±','ğŸ’»','ğŸ®','ğŸ“·','ğŸ§','âŒš','ğŸ‘•','ğŸ‘Ÿ','ğŸ”','â˜•','ğŸ°','ğŸ‚'];
  const randomIcon=icons[Math.floor(Math.random()*icons.length)];
  const colors=['bg-purple-500','bg-blue-500','bg-green-500','bg-red-500','bg-yellow-500','bg-pink-500','bg-indigo-500'];
  const randomColor=colors[Math.floor(Math.random()*colors.length)];
  const newProduct=document.createElement('div');
  newProduct.className='bg-white p-3 rounded-xl mb-2';
  newProduct.innerHTML=`
    <div class="flex items-center mb-2">
      <div class="w-12 h-12 rounded-lg ${randomColor} flex items-center justify-center mr-3"><span class="text-2xl">${randomIcon}</span></div>
      <input type="text" value="" class="flex-1 font-semibold text-sm border-b border-gray-300 focus:border-blue-500 outline-none px-2 py-1" placeholder="TÃªn sáº£n pháº©m">
      <p class="font-bold ml-3" id="total-${index}">Â¥0</p>
      <button onclick="removeProduct(this)" class="text-red-500 ml-2">âœ•</button>
    </div>
    <div class="flex items-center gap-2">
      <input type="number" value="1" onchange="updateQuantity(${index}, this.value)" class="w-16 text-sm font-semibold border rounded px-2 py-1" min="0" step="1" placeholder="SL">
      <select class="text-xs border rounded px-1 py-1">
        <option>cÃ¡i</option>
        <option>kg</option>
        <option>gÃ³i</option>
        <option>há»™p</option>
        <option>thÃ¹ng</option>
        <option>chai</option>
        <option>bá»™</option>
      </select>
      <span class="text-xs text-gray-500">Ã—</span>
      <input type="number" value="0" onchange="updatePrice(${index}, this.value)" class="w-24 text-sm font-semibold border rounded px-2 py-1" min="0" step="100" placeholder="ÄÆ¡n giÃ¡">
      <span class="text-xs text-gray-500" id="price-${index}">Â¥0</span>
    </div>
  `;
  productList.appendChild(newProduct);
  updateProductCount();
  calculate();
}

function removeProduct(btn){
  const productDiv=btn.closest('.bg-white.p-3.rounded-xl.mb-2');
  const index=Array.from(productDiv.parentElement.children).indexOf(productDiv);
  products.splice(index,1);
  productDiv.remove();
  updateProductCount();
  calculate();
}

function updateProductCount(){
  document.getElementById('product-count').textContent=products.length+' máº·t hÃ ng';
}

function calculate(){
  let subtotal=new Decimal(0);
  products.forEach((product,index)=>{
    const lineTotal=new Decimal(product.quantity).times(new Decimal(product.unitPrice));
    subtotal=subtotal.plus(lineTotal);
    document.getElementById('total-'+index).textContent=formatAmount(lineTotal.toNumber());
    document.getElementById('price-'+index).textContent=formatAmount(product.unitPrice);
  });
  const vatAmount=subtotal.times(new Decimal(vatRate));
  const grandTotal=subtotal.plus(vatAmount);
  document.getElementById('subtotal').textContent=formatAmount(subtotal.toNumber());
  document.getElementById('vat-amount').textContent=formatAmount(vatAmount.toNumber());
  document.getElementById('grand-total').textContent=formatAmount(grandTotal.toNumber());
  document.getElementById('export-total').textContent=formatAmount(grandTotal.toNumber());
  document.getElementById('total-revenue').textContent=formatAmount(grandTotal.toNumber());
}

function resetInvoice(){
  if(confirm('Reset hÃ³a Ä‘Æ¡n? / ãƒªã‚»ãƒƒãƒˆ?')){
    products=[];
    vatRate=0.08;
    document.getElementById('product-list').innerHTML='<!-- Sáº£n pháº©m sáº½ Ä‘Æ°á»£c thÃªm vÃ o Ä‘Ã¢y -->';
    document.getElementById('product-count').textContent='0 máº·t hÃ ng';
    setVAT(0.08);
    calculate();
  }
}

async function exportInvoice(){
  const btn=document.querySelector('button[onclick="exportInvoice()"]');
  const originalText=btn.textContent;
  btn.textContent='â³ Äang xuáº¥t PDF...';
  btn.disabled=true;
  
  try{
    const invoiceContent=document.getElementById('invoice-content');
    
    // áº¨n cÃ¡c nÃºt khÃ´ng cáº§n thiáº¿t
    const hideButtons=invoiceContent.querySelectorAll('button');
    hideButtons.forEach(b=>b.style.display='none');
    
    // Thay tháº¿ input báº±ng text Ä‘á»ƒ render Ä‘áº¹p hÆ¡n
    const inputs=invoiceContent.querySelectorAll('input, select');
    const replacements=[];
    
    inputs.forEach(input=>{
      const span=document.createElement('span');
      span.textContent=input.value||'';
      span.className=input.className;
      span.style.cssText=window.getComputedStyle(input).cssText;
      span.style.border='none';
      span.style.background='transparent';
      span.style.display='inline-block';
      span.style.minHeight='20px';
      
      if(input.value.trim()===''){
        span.style.display='none';
      }
      
      input.style.display='none';
      input.parentNode.insertBefore(span,input);
      replacements.push({input,span});
    });
    
    // Äá»£i DOM update
    await new Promise(resolve=>setTimeout(resolve,200));
    
    // Capture vá»›i cáº¥u hÃ¬nh tá»‘i Æ°u
    const canvas=await html2canvas(invoiceContent,{
      scale:2,
      useCORS:true,
      allowTaint:true,
      backgroundColor:'#ffffff',
      logging:false,
      width:invoiceContent.scrollWidth,
      height:invoiceContent.scrollHeight,
      windowWidth:invoiceContent.scrollWidth,
      windowHeight:invoiceContent.scrollHeight,
      onclone:(clonedDoc)=>{
        // Fix font trong báº£n clone
        const clonedContent=clonedDoc.getElementById('invoice-content');
        if(clonedContent){
          clonedContent.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
        }
      }
    });
    
    // KhÃ´i phá»¥c giao diá»‡n
    replacements.forEach(({input,span})=>{
      span.remove();
      input.style.display='';
    });
    hideButtons.forEach(b=>b.style.display='');
    
    // Táº¡o PDF
    const {jsPDF}=window.jspdf;
    const pdf=new jsPDF({
      orientation:'portrait',
      unit:'mm',
      format:'a4',
      compress:true
    });
    
    const imgData=canvas.toDataURL('image/png',1.0);
    const pdfWidth=210;
    const pdfHeight=(canvas.height*pdfWidth)/canvas.width;
    
    pdf.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight,'','FAST');
    
    // LÆ°u PDF
    const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const invoiceCode=document.getElementById('invoice-code').value||'invoice';
    const fileName=`${invoiceCode}-${Date.now()}.pdf`;
    
    if(isMobile){
      // TrÃªn mobile: Táº¡o blob vÃ  má»Ÿ
      const pdfBlob=pdf.output('blob');
      const url=URL.createObjectURL(pdfBlob);
      
      // Thá»­ má»Ÿ trong tab má»›i
      const newWindow=window.open(url,'_blank');
      
      if(newWindow){
        // ThÃ nh cÃ´ng
        setTimeout(()=>{
          alert('ğŸ“„ PDF Ä‘Ã£ má»Ÿ!\n\nâœ… Nháº¥n Share (â¬†ï¸) â†’ "Save to Files"\nâœ… Hoáº·c nháº¥n giá»¯ â†’ "Save to Photos"');
        },500);
      }else{
        // Fallback: Táº¡o link download
        const a=document.createElement('a');
        a.href=url;
        a.download=fileName;
        a.style.display='none';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(()=>{
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        },100);
        
        alert('âœ… PDF Ä‘Ã£ táº£i xuá»‘ng!\nKiá»ƒm tra trong Files app hoáº·c Downloads');
      }
    }else{
      // TrÃªn desktop: Download trá»±c tiáº¿p
      pdf.save(fileName);
      alert('âœ… PDF Ä‘Ã£ táº£i xuá»‘ng: '+fileName);
    }
    
  }catch(error){
    console.error('Export error:',error);
    alert('âŒ Lá»—i xuáº¥t PDF: '+error.message);
  }finally{
    btn.textContent=originalText;
    btn.disabled=false;
  }
}

if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{});}

// Set current date on load
function setCurrentDate(){
  const today=new Date();
  const year=today.getFullYear();
  const month=String(today.getMonth()+1).padStart(2,'0');
  const day=String(today.getDate()).padStart(2,'0');
  const dateStr=`${year}-${month}-${day}`;
  document.getElementById('invoice-date').value=dateStr;
}

setCurrentDate();
calculate();
</script>
</body>
</html>
